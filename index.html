<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Chanthiran Run Tracker Pro</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root { --neon-green: #32D74B; --accent-blue: #0A84FF; --danger-red: #FF453A; --card-bg: #1c1c1e; --warning-yellow: #FFCC00; }
        body { font-family: 'Inter', sans-serif; background-color: #000; color: #fff; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .header { padding: 25px 20px 10px 20px; display: flex; justify-content: space-between; align-items: center; }
        #fullDate { font-size: 0.9rem; font-weight: 900; }
        #liveClock { font-size: 1rem; font-weight: 800; opacity: 0.8; }
        .app-title { color: var(--neon-green); font-size: 1.1rem; font-weight: 900; text-transform: uppercase; margin: 0; }
        
        .main-display { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; position: relative; }
        #map { position: absolute; top: 10px; bottom: 10px; left: 15px; right: 15px; border-radius: 20px; border: 1px solid #333; z-index: 5; display: none; }
        .main-stat { font-size: clamp(6.5rem, 20vw, 8.5rem); font-weight: 900; margin: 0; background: linear-gradient(180deg, #fff 30%, var(--neon-green)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; z-index: 10; }
        
        .label-row { display: flex; align-items: center; gap: 10px; z-index: 10; }
        #accDisplay { font-size: 0.7rem; color: #444; font-weight: 900; }
        .sig-good { color: var(--accent-blue) !important; }
        
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; width: 100%; text-align: center; z-index: 10; margin-top: 15px; }
        .controls-bar { background: #121212; padding: 20px 20px 100px 20px; border-radius: 40px 40px 0 0; border-top: 1px solid #222; z-index: 100; }
        
        .progress-bg { width: 90%; height: 10px; background: #222; border-radius: 5px; overflow: hidden; margin: 10px 0;}
        .progress-fill { height: 100%; background: var(--neon-green); width: 0%; transition: width 0.5s; }

        .button-row { display: flex; width: 100%; justify-content: space-around; align-items: center; margin-top: 20px; }
        .btn { width: 50px; height: 50px; border-radius: 50%; border: none; background: #2c2c2e; color: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .btn-main { width: 80px; height: 80px; background: var(--neon-green); color: #000; }
        .stop { background: var(--danger-red) !important; color: #fff; }
        .new-run-circle { width: 55px; height: 55px; background: linear-gradient(145deg, #1b5e20, #32D74B); border-radius: 50%; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; }
        
        #pocketLockOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999; display: none; flex-direction: column; justify-content: center; align-items: center; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; display: none; align-items: flex-end; }
        .modal-content { background: var(--card-bg); width: 100%; border-radius: 30px 30px 0 0; max-height: 85vh; overflow-y: auto; padding-bottom: 50px; }
        .history-item { padding: 15px; border-bottom: 1px solid #333; position: relative; }
        .history-item .del-btn { position: absolute; right: 20px; top: 20px; color: var(--danger-red); cursor: pointer; }
        .standard-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2100; display: none; justify-content: center; align-items: center; }
        .modal-card { background: var(--card-bg); width: 85%; padding: 25px; border-radius: 20px; text-align: center; }
        .modal-card input { width: 90%; padding: 12px; margin: 10px 0; border-radius: 10px; border: none; background: #333; color: #fff; }
        .hidden { display: none; }
    </style>
</head>
<body onclick="resetIdleTimer()">

<div id="pocketLockOverlay" ondblclick="unlockPocket()">
    <span class="material-icons-round" style="font-size: 5rem; color: #333;">lock</span>
    <p style="color: #444; font-weight: 800;">DOUBLE-TAP TO UNLOCK</p>
</div>

<div class="header">
    <div class="header-info">
        <span id="fullDate">--/--/----</span>
        <span id="liveClock">00:00:00</span>
    </div>
    <div style="text-align: right;">
        <div class="app-title">Chanthiran</div>
        <div style="font-size: 0.6rem; letter-spacing: 2px; color: var(--neon-green);">RUN TRACKER</div>
    </div>
</div>

<div class="main-display">
    <div id="map"></div>
    <p class="main-stat" id="distance">0.00</p>
    <div class="label-row">
        <span style="letter-spacing: 3px; font-weight: 800; color: #666;">KILOMETERS</span>
        <span id="gpsIcon" class="material-icons-round">gps_fixed</span>
        <span id="accDisplay">--m</span>
    </div>
    <div class="stats-grid">
        <div><h2 id="timer" style="margin:0;">00:00</h2><p style="font-size:0.6rem; color:#888;">TIME</p></div>
        <div><h2 id="pace" style="margin:0;">0'00"</h2><p style="font-size:0.6rem; color:#888;">PACE</p></div>
    </div>
</div>

<div class="controls-bar">
    <div style="width:90%; display:flex; justify-content: space-between; font-size: 0.8rem; font-weight: 900; margin-bottom: 5px;">
        <span><span class="material-icons-round" style="font-size:16px; vertical-align:middle; color:var(--warning-yellow); cursor:pointer;" onclick="document.getElementById('goalModal').style.display='flex'">edit</span> DONE: <b id="doneKm">0.00</b></span>
        <span>BAL: <b id="balKm">0.00</b></span>
    </div>
    
    <div class="progress-bg"><div class="progress-fill" id="progressBar"></div></div>

    <div style="width:90%; display:flex; justify-content: space-between; align-items:center; color:var(--accent-blue); font-size:0.8rem; margin-top:5px;">
        <span onclick="document.getElementById('locModal').style.display='flex'" style="cursor:pointer;"><span class="material-icons-round" style="font-size:16px; vertical-align:middle;">place</span> <b id="locDisplay">SET ROUTE</b></span>
        <span id="daysDisplay" style="color:var(--warning-yellow); font-weight:800;">0 DAYS LEFT</span>
    </div>

    <div class="button-row">
        <button class="btn" onclick="document.getElementById('pocketLockOverlay').style.display='flex'"><span class="material-icons-round">screen_lock_portrait</span></button>
        <button class="btn" onclick="openHistory()"><span class="material-icons-round">analytics</span></button>
        <div class="new-run-circle" onclick="resetAll()">
            <span style="font-size: 0.6rem; color:#fff; font-weight:900;">NEW</span>
            <span style="font-size: 0.7rem; color:#fff; font-weight:900;">RUN</span>
        </div>
        <button id="startBtn" class="btn btn-main" onclick="toggleStart()"><span class="material-icons-round" id="startIcon" style="font-size:3rem;">play_arrow</span></button>
        <button id="stopBtn" class="btn btn-main stop hidden" onclick="stopAndSave()"><span class="material-icons-round" style="font-size:3rem;">stop</span></button>
        <button onclick="toggleMap()" class="btn"><span class="material-icons-round">map</span></button>
    </div>
</div>

<div id="historyModal" class="modal">
    <div class="modal-content">
        <div style="padding:25px; display:flex; justify-content:space-between; align-items:center; position: sticky; top:0; background:#1c1c1e; z-index:100;">
            <h2 style="margin:0; color:var(--neon-green);">HISTORY</h2>
            <div style="display:flex; gap:18px;">
                <span class="material-icons-round" onclick="generateAndProcessPdf('save')" style="color:var(--accent-blue); cursor:pointer; font-size:30px;">picture_as_pdf</span>
                <span class="material-icons-round" onclick="generateAndProcessPdf('share')" style="color:var(--warning-yellow); cursor:pointer; font-size:30px;">share</span>
                <span class="material-icons-round" onclick="document.getElementById('historyModal').style.display='none'" style="font-size:30px; cursor:pointer;">close</span>
            </div>
        </div>
        <div id="lapList"></div>
    </div>
</div>

<div id="locModal" class="standard-modal">
    <div class="modal-card">
        <h3>ROUTE NAME</h3>
        <input type="text" id="locInput" placeholder="Enter name">
        <button onclick="updateLoc()" style="background:var(--accent-blue); color:white; border:none; padding:10px; border-radius:10px; width:100%;">SAVE</button>
    </div>
</div>

<div id="goalModal" class="standard-modal">
    <div class="modal-card">
        <h3>SET GOAL</h3>
        <input type="number" id="goalInput" placeholder="Target KM">
        <input type="date" id="dateInput">
        <button onclick="updateGoal()" style="background:var(--neon-green); color:black; border:none; padding:10px; border-radius:10px; width:100%;">SAVE GOAL</button>
        <button onclick="document.getElementById('goalModal').style.display='none'" style="background:transparent; color:#888; border:none; margin-top:10px;">CANCEL</button>
    </div>
</div>

<script>
let sessionDistance = 0, totalSeconds = 0, sessionSplits = [], lastCoords = null, watchID, timerInterval;
let db, map, routeLine, currentMarker, mapState = 0, isRunning = false, idleTimer;
let lastSpokenMilestone = 0;

let totalAccumulated = parseFloat(localStorage.getItem('chan_total')) || 0;
let routeName = localStorage.getItem('chan_loc') || "NOT SET";
let targetGoal = parseFloat(localStorage.getItem('chan_target')) || 0;
let targetDate = localStorage.getItem('chan_target_date') || "";

// Database Setup - Forced Update to Version 17
const dbReq = indexedDB.open("ChanthiranDB", 17);
dbReq.onupgradeneeded = (e) => {
    let db = e.target.result;
    if(db.objectStoreNames.contains("runs")) db.deleteObjectStore("runs");
    db.createObjectStore("runs", { keyPath: "id", autoIncrement: true });
};
dbReq.onsuccess = (e) => { db = e.target.result; };

window.onload = () => {
    document.getElementById('fullDate').innerText = new Date().toLocaleDateString('en-GB');
    document.getElementById('locDisplay').innerText = routeName;
    document.getElementById('doneKm').innerText = totalAccumulated.toFixed(2);
    updateProgress();
    setInterval(() => { document.getElementById('liveClock').innerText = new Date().toTimeString().split(' ')[0]; }, 1000);
    initMap();
};

function initMap() {
    map = L.map('map', { zoomControl: false }).setView([3.139, 101.686], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    routeLine = L.polyline([], {color: '#32D74B', weight: 5}).addTo(map);
    currentMarker = L.circleMarker([0, 0], {radius: 7, color: '#0A84FF', fillOpacity: 1}).addTo(map);
}

function speak(text) {
    window.speechSynthesis.cancel();
    const msg = new SpeechSynthesisUtterance(text);
    msg.rate = 0.95;
    window.speechSynthesis.speak(msg);
}

function resetIdleTimer() {
    clearTimeout(idleTimer);
    if(isRunning) idleTimer = setTimeout(() => { document.getElementById('pocketLockOverlay').style.display = 'flex'; }, 30000);
}

function unlockPocket() { document.getElementById('pocketLockOverlay').style.display = 'none'; resetIdleTimer(); }

function checkMilestones() {
    let currentMilestone = Math.floor(sessionDistance * 2) / 2;
    if (currentMilestone > lastSpokenMilestone) {
        lastSpokenMilestone = currentMilestone;
        if (currentMilestone === 5) { speak("5 kilometers. Just run."); return; }
        if (currentMilestone === 10) { speak("10 kilometers. Keep moving."); return; }
        if (currentMilestone % 1 === 0) {
            let t = document.getElementById('timer').innerText.split(':');
            let p = document.getElementById('pace').innerText.replace('"', '').split("'");
            speak(`${currentMilestone} kilometers. Time: ${parseInt(t[0])} minutes ${t[1]} seconds. Pace: ${p[0]} minutes ${p[1]} seconds.`);
        } else { speak(`${currentMilestone} kilometers.`); }
    }
}

function toggleStart() {
    const icon = document.getElementById('startIcon');
    if(icon.innerText === "play_arrow") {
        icon.innerText = "pause";
        isRunning = true;
        document.getElementById('stopBtn').classList.remove('hidden');
        speak(totalSeconds === 0 ? "Enjoy your run Chanthiran" : "Resuming run");
        startTracking();
        resetIdleTimer();
    } else {
        icon.innerText = "play_arrow";
        isRunning = false;
        speak("Run paused");
        clearInterval(timerInterval);
        clearTimeout(idleTimer);
        navigator.geolocation.clearWatch(watchID);
    }
}

function startTracking() {
    timerInterval = setInterval(() => { totalSeconds++; updateUI(); }, 1000);
    watchID = navigator.geolocation.watchPosition(pos => {
        const { latitude: lat, longitude: lng, accuracy } = pos.coords;
        document.getElementById('accDisplay').innerText = Math.round(accuracy) + "m";
        document.getElementById('gpsIcon').classList.toggle('sig-good', accuracy < 20);
        currentMarker.setLatLng([lat, lng]);
        if(accuracy < 30 && lastCoords) {
            const d = calcDist(lastCoords.lat, lastCoords.lng, lat, lng);
            if(d > 0.005) { 
                sessionDistance += d;
                routeLine.addLatLng([lat, lng]);
                let currentKm = Math.floor(sessionDistance);
                if(currentKm > sessionSplits.length) sessionSplits.push({ km: currentKm, time: document.getElementById('timer').innerText });
                checkMilestones();
                updateUI();
            }
        }
        lastCoords = {lat, lng};
    }, null, { enableHighAccuracy: true });
}

function stopAndSave() {
    if(!confirm("Finish and save?")) return;
    isRunning = false; clearTimeout(idleTimer);
    const finalDist = sessionDistance.toFixed(2);
    const runData = { date: new Date().toLocaleDateString('en-GB'), distance: finalDist, duration: document.getElementById('timer').innerText, pace: document.getElementById('pace').innerText, location: routeName, splits: sessionSplits };
    
    // Improved Save Logic
    const transaction = db.transaction(["runs"], "readwrite");
    const store = transaction.objectStore("runs");
    const addRequest = store.add(runData);

    addRequest.onsuccess = () => {
        totalAccumulated += sessionDistance;
        localStorage.setItem('chan_total', totalAccumulated);
        speak(`Run completed and saved. Final distance ${finalDist} kilometers. Well done Chan!`);
        setTimeout(() => location.reload(), 4500);
    };
    
    addRequest.onerror = (err) => {
        alert("Save failed! Please check if your storage is full.");
        console.error(err);
    };
}

async function generateAndProcessPdf(mode) {
    const event = prompt("Report Title:", "Chanthiran_Run_Report") || "Report";
    const tx = db.transaction("runs", "readonly");
    const store = tx.objectStore("runs");
    const request = store.getAll();

    request.onsuccess = async () => {
        const runs = request.result;
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        doc.setFontSize(22); doc.setTextColor(50, 215, 75); doc.text("CHANTHIRAN RUN REPORT", 14, 20);
        doc.setFontSize(14); doc.setTextColor(0); doc.text(`${event.toUpperCase()}`, 14, 30);
        
        doc.autoTable({ 
            startY: 40, 
            head: [['Date', 'KM', 'Time', 'Pace', 'Route']], 
            body: runs.reverse().map(r => [r.date, r.distance, r.duration, r.pace, r.location])
        });
        
        doc.setFontSize(12);
        doc.text("__________________________", 14, doc.internal.pageSize.height - 20);
        doc.text("Chanthiran Sivaperuman", 14, doc.internal.pageSize.height - 12);
        
        const fileName = `${event.replace(/\s+/g, '_')}.pdf`;
        
        if(mode === 'save') {
            doc.save(fileName);
        } else {
            const pdfBlob = doc.output('blob');
            const file = new File([pdfBlob], fileName, { type: 'application/pdf' });
            
            if (navigator.canShare && navigator.canShare({ files: [file] })) {
                await navigator.share({ files: [file], title: event, text: 'Official Run Report' });
            } else {
                alert("Direct sharing not supported on this browser. File will be downloaded.");
                doc.save(fileName);
            }
        }
    };
}

function deleteRun(id) { if(confirm("Delete run?")) db.transaction("runs", "readwrite").objectStore("runs").delete(id).onsuccess = () => openHistory(); }
function resetAll() { if(confirm("Start a New Season? Clears everything!")) { speak("It's a new run. Run for health!"); localStorage.clear(); indexedDB.deleteDatabase("ChanthiranDB"); setTimeout(() => location.reload(), 3000); } }

function openHistory() {
    document.getElementById('historyModal').style.display = 'flex';
    const list = document.getElementById('lapList'); list.innerHTML = "";
    db.transaction("runs", "readonly").objectStore("runs").getAll().onsuccess = e => {
        e.target.result.reverse().forEach(r => {
            const div = document.createElement('div'); div.className = "history-item";
            div.innerHTML = `<b>${r.date}</b> | ${r.distance}KM | ${r.duration}<br><small>${r.location}</small>
            <span class="material-icons-round del-btn" onclick="deleteRun(${r.id})">delete</span>`;
            list.appendChild(div);
        });
    };
}

function toggleMap() { mapState = !mapState; document.getElementById('map').style.display = mapState ? 'block' : 'none'; if(mapState) map.invalidateSize(); }
function updateLoc() { localStorage.setItem('chan_loc', document.getElementById('locInput').value); location.reload(); }
function updateGoal() { 
    localStorage.setItem('chan_target', document.getElementById('goalInput').value); 
    localStorage.setItem('chan_target_date', document.getElementById('dateInput').value); 
    location.reload(); 
}

function updateProgress() { 
    if(targetGoal > 0) { 
        document.getElementById('progressBar').style.width = Math.min((totalAccumulated/targetGoal)*100, 100) + "%"; 
        document.getElementById('balKm').innerText = Math.max(targetGoal - totalAccumulated, 0).toFixed(2); 
    }
    if(targetDate) {
        const diff = new Date(targetDate) - new Date();
        const days = Math.ceil(diff / (1000 * 60 * 60 * 24));
        document.getElementById('daysDisplay').innerText = `${Math.max(days, 0)} DAYS LEFT`;
    }
}

function calcDist(l1, o1, l2, o2) { const R = 6371; const dL = (l2-l1)*Math.PI/180; const dO = (o2-o1)*Math.PI/180; const a = Math.sin(dL/2)**2 + Math.cos(l1*Math.PI/180)*Math.cos(l2*Math.PI/180)*Math.sin(dO/2)**2; return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); }

function updateUI() {
    document.getElementById('distance').innerText = sessionDistance.toFixed(2);
    const m = Math.floor(totalSeconds / 60).toString().padStart(2, '0');
    const s = (totalSeconds % 60).toString().padStart(2, '0');
    document.getElementById('timer').innerText = `${m}:${s}`;
    if(sessionDistance > 0.01) {
        let p = (totalSeconds/60)/sessionDistance;
        document.getElementById('pace').innerText = `${Math.floor(p)}'${Math.floor((p%1)*60).toString().padStart(2,'0')}"`;
    }
}
</script>
</body>
</html>
